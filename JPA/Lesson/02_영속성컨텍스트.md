

## 영속성 컨텍스트
- 논리적인 개념이다.
- 엔티티 매니저를 통해서 영속성 컨텍스트에 접근한다.
- __"엔티티를 영구 저장하는 환경"__ 이라는 뜻

## 엔티티의 생명주기
- 비영속
    - 영속성 컨텍스트와 전혀 관계가 앖는 새로운 상태   
- 영속
    - 영속성 컨텍스트에 관리되는 상태
- 준영속
    - 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제
    - 말그대로 삭제된 상태


- 비영속상태란
    - 객체만 생성한 상태


- 준영속 상태
    - 특정 엔티티를 영속성 컨텍스트에서 분리시킨다
    - em.detach(인스턴스)

## 영속성 컨텍스트의 이점
- 1차 캐시
- 동일성 보장
- 트랜잭션을 지원하는 쓰기 지연
- 변경 감지
- 지연 로딩

영속성 컨텍스트란 객체와 DB 사이에 중간계층에 존재하는 것이다.
중간에 거쳐가는 것이 있을 수 있다는 것은 캐싱과 같은 것들을 처리할 수 있는 무언가의 개념이 될 수 있다.


## 영속성 컨텍스트의 특징
- 동일한 데이터의 2회이상 조회 시
    - 독립된 영속성 컨텍스트에서 최초 조회 시 DB에서 데이터를 조회한다.
    - 조회한 뒤 1차캐시에 저장된다.
    - 그 뒤 같은 PK값으로 동일한 조회를 요청하면 1차캐시에서 저장된 데이터를 조회한다.
    - 결론적으로 DB에는 1번만 조회 요청을 실행한다

- 영속 엔티티의 동일성을 보장
    - 같은 트랜잭션 내에서 동일한 객체를 조회하여 비교 시 동일객체로 확인가능하다.
    - 마치 자바컬렉션에서 꺼내면 참조주소로 비교하여 동일객체로 비교가능한 것처럼

- 트랜잭션 쓰기 지연
    - 만약 2개 이상 엔티티를 영속성 컨텍스트에 등록했다면 이 떄 DB에 쿼리가 2번 나가야하는 상황이다.
    - 이 떄 트랜잭션 커밋을 해주는 순간에 DB에 한꺼번에 INSERT 쿼리가 실행된다.
    - 즉 persist 메소드를 2번 실행한다고 해서 그 순간에 DB에 INSERT 되는 것이 아니라 commit할 때 INSERT SQL을 보낸다.

- 변경 감지
    - 영속성컨텍스트 내에서 조회 후 setName만 하면 업데이트 쿼리를 자동으로 실행한다.( 따로 persit하지 않았는데도 위와 같이 처리해준다.)
    